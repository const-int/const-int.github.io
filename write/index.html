<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create post</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/translit.js"></script>
  <script src="js/save-post.js"></script>

  <style>
    #download {
      outline: none !important;
    }
  </style>

</head>
<body>

  <div class="container">
    <h1 style="text-align: center">Write a new post</h1>
    <div class="form-horizontal">
      <div class="form-group">
        <label for="category" class="col-sm-2 control-label">Category:</label>
        <div class="col-sm-10">
          <select class="field3 form-control" id="category">
            <option value="life">life</option>
            <option value="web">web</option>
            <option value="news">news</option>
            <option value="thoughts">thoughts</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="title" class="col-sm-2 control-label">Title:</label>
        <div class="col-sm-10">
          <input type="text" class="field1 form-control" id="title">
        </div>
      </div>
      <div class="form-group">
        <label for="excerpt" class="col-sm-2 control-label">Excerpt:</label>
        <div class="col-sm-10">
          <input type="text" class="field1 form-control" id="excerpt">
        </div>
      </div>
      <div class="form-group">
        <label for="content" class="col-sm-2 control-label">Text:</label>
        <div class="col-sm-10">
          <textarea id="content" rows="10" class="field2 form-control"></textarea>
        </div>
      </div>
      <div class="form-group">
        <label for="poster" class="col-sm-2 control-label">Poster:</label>
        <div class="col-sm-10">
          <input type="file" class="field1 form-control post-image" data-index='1' id="poster">
        </div>
      </div>
      <div class="form-group">
        <label for="ava" class="col-sm-2 control-label">Avatar:</label>
        <div class="col-sm-10">
          <input type="file" class="field1 form-control post-image" data-index='2' id="ava">
        </div>
      </div>
      <div class="form-group">
        <label for="add-image" class="col-sm-2 control-label">Images:</label>
        <div class="col-sm-10">
          <input type="file" multiple="multiple" class="field1 form-control input-image" id="add-image">
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-offset-2 col-sm-10">
          <button id="download" class="btn btl-large btn-default">Download Post File</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  jQuery(document).ready(function($) {

    pictures = ['',''];
    imgs = {};

    add_input = $('#add-image');

    function readImage(input) {
            var FR = new FileReader();
            var index = $(input).data('index') - 1;
            FR.onload = function(e) {
              pictures[index] = e.target.result;
            };
            FR.readAsDataURL( input.files[0] );
    }


    function addImageToContent(input, i, filename) {
        var FR = new FileReader();
        FR.onload = function(e) {
          imgs[filename] = e.target.result;
          console.log(imgs);
          $('#content').val($('#content').val() + '\n{{ '+ filename +' }}\n' );
          add_input.replaceWith( add_input.val('').clone( true ) );
        };
        FR.readAsDataURL( input.files[i] );
    }


    $(".post-image").change(function(){
        readImage( this );
    });

    $(".input-image").change(function(){

      var files = $(".input-image")[0].files
      for (var i = 0; i < files.length; i++) {

        var fullPath = files[i].name;
        if (fullPath) {
          var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
          var filename = fullPath.substring(startIndex);
          if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
            filename = filename.substring(1);
          }
          var fl = filename.split('.')[0];
          fl = fl.replace(/-/g,'_');

          addImageToContent(this, i, fl );
        }
      }

    });


    $('.field1').on('keydown', function (event) {
      if (event.which == 13) {
          $('.field2').focus()
          event.preventDefault();
      }
    });

    $('#download').click(function(event) {
      var d = new Date();
      var year = d.getFullYear();
      var month = ("0" + (d.getMonth() + 1)).slice(-2)
      var date = ('0' + d.getDate()).slice(-2);
      var hours = ('0' + d.getHours()).slice(-2);
      var minutes = ('0' + d.getMinutes()).slice(-2);
      var seconds = ('0' + d.getSeconds()).slice(-2);

      var title = $('#title').val();
      var category = $('#category').val();
      var excerpt = $('#excerpt').val();
      var content_short = $('#content').val();

      content = content_short.replace(/\{\{\s(\w*)\s\}\}/g,
        function (match, value) {
          return '<p><img src="'+imgs[value]+'" alt=""></p>';
      })


      if (title == '') {
        alert('Complete title field!');
        return;
      }

      var filename = translit([year, month, date, title].join('-'));
      var file_content =
       '---\nlayout: post\ntitle: ' + title
        + '\ndate: ' + year + '-' + month + '-' + date + ' ' + hours + ':' + minutes + ':' + seconds
        + '\nposter: ' + pictures[0]
        + '\nava: ' + pictures[1]
        + '\nexcerpt: ' + excerpt
        + '\ncategories: ' + category
        + '\n---\n\n' + content;

      var blob = new Blob([file_content],
          {type: "text/plain;charset=utf-8"});

      saveAs(blob, filename + ".md");
    });

  });


  </script>
</body>
</html>