<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Create post</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-theme.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/translit.js"></script>
  <script src="js/save-post.js"></script>

  <style>
    @media (min-width: 1000px) {
      .container {
        width: 700px !important;
      }

      .no-padding-right {
        padding-right: 0;
      }
    }

    @media (max-width: 1000px) {
      .no-padding-right {
        margin-bottom: 15px;
      }

      .title-wrap, .category-wrap {
        margin-bottom: 15px;
      }
    }

    body {
      font-size: 1.5em !important;
    }

    input[type="file"] {
      display: none;
    }



    .input-btn, #download {
      width: 100%;
    }
    #download {
      outline: none !important;
    }

    * {
      outline: none !important;
    }

    @media (min-width: 1000px) {
      .no-padding {
        padding: 0;
      }
    }
  </style>

</head>
<body>

  <div class="container">
    <h1 style="text-align: center; margin-bottom: 40px">New post form</h1>
    <div class="form-horizontal">
      <div class="form-group">
        <div class="col-sm-8 title-wrap">
          <input type="text" placeholder="Title" class="field1 form-control" id="title">
        </div>
        <div class="col-sm-2 no-padding category-wrap">
          <select class="field3 form-control" id="category">
            <option value="life">life</option>
            <option value="web">web</option>
            <option value="news">news</option>
            <option value="thoughts">thoughts</option>
          </select>
        </div>
        <div class="col-sm-2">
          <select class="field3 form-control" id="lang">
            <option value="ru">RU</option>
            <option value="en">EN</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-12">
          <input type="text" placeholder="Excerpt" class="field1 form-control" id="excerpt">
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-12">
          <textarea id="content" placeholder="Post content" rows="10" class="field2 form-control"></textarea>
        </div>
      </div>
      <div class="form-group">
        <div class="col-sm-3 no-padding-right">
          <button type="button" class="input-btn btn btn-default">Upload Poster</button>
          <input type="file" class="field1 form-control post-image" data-index='1' id="poster">
        </div>
        <div class="col-sm-3 no-padding-right">
          <button type="button" class="input-btn btn btn-default">Upload Avatar</button>
          <input type="file" class="field1 form-control post-image" data-index='2' id="ava">
        </div>
        <div class="col-sm-3 no-padding-right">
          <button type="button" id="img_upload" class="input-btn btn btn-default">Upload Images</button>
          <input type="file" multiple="multiple" class="field1 form-control input-image" id="add-image">
        </div>
        <div class="col-sm-3">
          <button id="download" class="btn btl-large btn-primary">Download File</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  jQuery(document).ready(function($) {

    $('.input-btn').click(function(event) {
      $(this).siblings('input[type=file]').click();
    });

    pictures = ['',''];
    imgs = {};
    img_size = 0;

    add_input = $('#add-image');

    function readImage(input) {
            var FR = new FileReader();
            var index = $(input).data('index') - 1;
            $(input).siblings('.btn')
              .addClass('btn-success')
              .text('Uploaded');
            FR.onload = function(e) {
              pictures[index] = e.target.result;
            };
            FR.readAsDataURL( input.files[0] );
    }


    function addImageToContent(input, i, filename) {
        var FR = new FileReader();
        img_size++;
        FR.onload = function(e) {
          imgs[filename] = e.target.result;
          $('#content').val($('#content').val() + '\n{{ '+ filename +' }}\n' );
          add_input.replaceWith( add_input.val('').clone( true ) );
          $('#img_upload').text('Uploaded ' + img_size + ' images');
        };
        FR.readAsDataURL( input.files[i] );
    }


    $(".post-image").change(function(){
        readImage( this );
    });

    $(".input-image").change(function(){

      var files = $(".input-image")[0].files
      for (var i = 0; i < files.length; i++) {

        var fullPath = files[i].name;
        if (fullPath) {
          var startIndex = (fullPath.indexOf('\\') >= 0 ? fullPath.lastIndexOf('\\') : fullPath.lastIndexOf('/'));
          var filename = fullPath.substring(startIndex);
          if (filename.indexOf('\\') === 0 || filename.indexOf('/') === 0) {
            filename = filename.substring(1);
          }
          var fl = filename.split('.')[0];
          fl = fl.replace(/-/g,'_');

          addImageToContent(this, i, fl );
        }
      }

    });


    $('.field1').on('keydown', function (event) {
      if (event.which == 13) {
          $('.field2').focus()
          event.preventDefault();
      }
    });

    $('#download').click(function(event) {
      var d = new Date();
      var year = d.getFullYear();
      var month = ("0" + (d.getMonth() + 1)).slice(-2)
      var date = ('0' + d.getDate()).slice(-2);
      var hours = ('0' + d.getHours()).slice(-2);
      var minutes = ('0' + d.getMinutes()).slice(-2);
      var seconds = ('0' + d.getSeconds()).slice(-2);

      var title = $('#title').val();
      var category = $('#category').val();
      var lang = $('#lang').val();
      var excerpt = $('#excerpt').val();
      var content_short = $('#content').val();

      content = content_short.replace(/\{\{\s(\w*)\s\}\}/g,
        function (match, value) {
          return '<p><img src="'+imgs[value]+'" alt=""></p>';
      })


      if (title == '') {
        alert('Complete title field!');
        return;
      }

      var filename = translit([year, month, date, title].join('-'));
      var file_content =
       '---\nlayout: post\ntitle: ' + title
        + '\ndate: ' + year + '-' + month + '-' + date + ' ' + hours + ':' + minutes + ':' + seconds
        + '\nava: ' + pictures[1]
        + '\nexcerpt: ' + excerpt
        + '\ncategories: ' + lang + ' ' + category
        + '\n---\n\n'
        + '## ' + pictures[0] + '## {#poster-holder}\n' + content;

      var blob = new Blob([file_content],
          {type: "text/plain;charset=utf-8"});

      saveAs(blob, filename + ".md");
    });

  });


  </script>
</body>
</html>